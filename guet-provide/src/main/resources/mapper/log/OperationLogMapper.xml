<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.yang.mapper.OperationLogMapper">

    <resultMap id="LogMap" type="com.yang.pojo.GuetOperationLog" autoMapping="true">
        <id property="id" column="id"/>
        <result property="userId" column="user_id"/>
        <result property="username" column="username"/>
        <result property="module" column="module"/>
        <result property="operation" column="operation"/>
        <result property="method" column="method"/>
        <result property="params" column="params"/>
        <result property="ip" column="ip"/>
        <result property="status" column="status"/>
        <result property="errorMsg" column="error_msg"/>
        <result property="createTime" column="create_time"/>
    </resultMap>

    <!-- 插入日志 -->
    <insert id="insert" useGeneratedKeys="true" keyProperty="id">
        INSERT INTO guet_operation_log (user_id, username, module, operation, method, params, ip, status, error_msg, create_time)
        VALUES (#{userId}, #{username}, #{module}, #{operation}, #{method}, #{params}, #{ip}, #{status}, #{errorMsg}, now())
    </insert>

    <!-- 分页查询日志 -->
    <select id="selectPage" resultMap="LogMap">
        SELECT * FROM guet_operation_log
        <where>
            <if test="module != null and module != ''">
                AND module = #{module}
            </if>
            <if test="operation != null and operation != ''">
                AND operation LIKE CONCAT('%', #{operation}, '%')
            </if>
            <if test="username != null and username != ''">
                AND username LIKE CONCAT('%', #{username}, '%')
            </if>
            <if test="status != null">
                AND status = #{status}
            </if>
        </where>
        ORDER BY create_time DESC
        LIMIT #{offset}, #{size}
    </select>

    <!-- 查询日志总数 -->
    <select id="selectCount" resultType="int">
        SELECT COUNT(*) FROM guet_operation_log
        <where>
            <if test="module != null and module != ''">
                AND module = #{module}
            </if>
            <if test="operation != null and operation != ''">
                AND operation LIKE CONCAT('%', #{operation}, '%')
            </if>
            <if test="username != null and username != ''">
                AND username LIKE CONCAT('%', #{username}, '%')
            </if>
            <if test="status != null">
                AND status = #{status}
            </if>
        </where>
    </select>

    <!-- 查询日志列表 -->
    <select id="selectList" resultMap="LogMap">
        SELECT * FROM guet_operation_log
        <where>
            <if test="username != null and username != ''">
                AND username LIKE CONCAT('%', #{username}, '%')
            </if>
            <if test="module != null and module != ''">
                AND module = #{module}
            </if>
            <if test="startTime != null and startTime != ''">
                AND create_time >= #{startTime}
            </if>
            <if test="endTime != null and endTime != ''">
                AND create_time &lt;= #{endTime}
            </if>
        </where>
        ORDER BY create_time DESC
    </select>

    <!-- 查询最近的日志 -->
    <select id="selectRecent" resultMap="LogMap">
        SELECT * FROM guet_operation_log
        ORDER BY create_time DESC
        LIMIT #{limit}
    </select>

    <!-- 删除指定天数之前的日志 -->
    <delete id="deleteByDays">
        DELETE FROM guet_operation_log
        WHERE create_time &lt; DATE_SUB(NOW(), INTERVAL #{days} DAY)
    </delete>

    <!-- 删除所有日志 -->
    <delete id="deleteAll">
        DELETE FROM guet_operation_log
    </delete>

</mapper>
