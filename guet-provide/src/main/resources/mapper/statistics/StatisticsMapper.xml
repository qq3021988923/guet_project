<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.yang.mapper.StatisticsMapper">

    <!-- 按日期统计订单数量和金额（最近N天） -->
    <select id="getOrderStatsByDate" resultType="java.util.Map">
        SELECT 
            DATE(create_time) as date,
            COUNT(*) as count,
            IFNULL(SUM(order_total), 0) as total
        FROM guet_order
        WHERE create_time >= DATE_SUB(CURDATE(), INTERVAL #{days} DAY)
        GROUP BY DATE(create_time)
        ORDER BY date ASC
    </select>

    <!-- 按运输方式统计订单数量 -->
    <select id="getOrderStatsByShipping" resultType="java.util.Map">
        SELECT 
            IFNULL(order_shipping, '未知') as name,
            COUNT(*) as value
        FROM guet_order
        GROUP BY order_shipping
    </select>

    <!-- 按城市统计订单数量 -->
    <select id="getOrderStatsByCity" resultType="java.util.Map">
        SELECT 
            IFNULL(order_citi, '未知') as name,
            COUNT(*) as value
        FROM guet_order
        GROUP BY order_citi
        ORDER BY value DESC
        LIMIT 10
    </select>

    <!-- 按物流状态统计订单数量 -->
    <select id="getOrderStatsByLogisticsStatus" resultType="java.util.Map">
        SELECT 
            CASE l.status
                WHEN 1 THEN '待取件'
                WHEN 2 THEN '已取件'
                WHEN 3 THEN '运输中'
                WHEN 4 THEN '已送达'
                WHEN 5 THEN '已签收'
                ELSE '未知'
            END as name,
            COUNT(*) as value
        FROM guet_order o
        LEFT JOIN (
            SELECT order_id, status FROM guet_logistics 
            WHERE id IN (SELECT MAX(id) FROM guet_logistics GROUP BY order_id)
        ) l ON o.order_id = l.order_id
        GROUP BY l.status
    </select>

    <!-- 获取总营收（按用户ID过滤） -->
    <select id="getTotalRevenue" resultType="java.util.Map">
        SELECT 
            COUNT(*) as orderCount,
            IFNULL(SUM(order_total), 0) as totalRevenue,
            IFNULL(AVG(order_total), 0) as avgRevenue
        FROM guet_order
        <where>
            <if test="userId != null">
                user_id = #{userId}
            </if>
        </where>
    </select>

</mapper>
